---
title: JDBC properties for setting rollback scope 
originalFilePath: jdbctxnrollback.md

---

If you are using a JDBC connector to connect to a client application, you use the `autosave` and 'transaction_rollback_scope' properties in conjunction to specify the transaction rollback scope.

You can specify these properties in either the connection URL or as an
additional properties object parameter to DriverManager.getConnection.

## autosave

The `autosave` parameter is a string that specifies what the driver should do if a query containing
      multiple statements fails. the possible values: server, always, never, conservative. 

- In `autosave=server` mode, JDBC relies on the server side parameter `transaction_rollback_scope`
to save each statement via internal server savepoints before
executing the next. The server automatically rollbacks to the previous
statement if any statement in the query fails. If this parameter
is not supported on server side, JDBC rejects the connection. 

- In
`autosave=always` mode, JDBC driver first tries to use the server
side `transaction_rollback_scope` property. If it is not supported,
then JDBC driver itself sets a savepoint before each query
statement, and rolls back to that savepoint in case of failure.
      
- In `autosave=never` mode (default), no savepoint activity is ever
carried out. In `autosave=conservative` mode, savepoint is set for
each query, however the rollback is done only for rare cases like
'cached statement cannot change return type' or 'statement XXX is
not valid' so JDBC driver rollsback and retries

The default value for this property is `never`

This `autosave=server` property is not useful
without the PostgreSQL server providing `transaction_rollback_scope`
functionality.

## transaction_rollback_scope

The `autosave` parameter is a string that determines the range of
operations which roll back when an SQL statement fails. 

The default value is `TRANSACTION`, which causes the entire transaction or
current subtransaction to be rolled back. This is the only mode
that can be selected with `SET TRANSACTION` command. 
      
The other possible mode, `STATEMENT`, can only be specified during connection
establishment, `ALTER USER` or `ALTER DATABASE`; in that mode, only
the failed `SQL` statement is rolled back, and the transaction is
automatically put back in normal mode.

## `autosave` test cases
Test cases for trying out various values of this **autosave** property
are available in the `BatchAutoSaveTest.java` file. The following
SQL snippet demonstrates the behavior that is expected when the
server provides `transaction_rollback_scope` functionality and
`autosave=server` is used on the JDBC side.

```sql
CREATE TABLE test (id INT PRIMARY KEY);
INSERT INTO test VALUES (2);
BEGIN;
INSERT INTO test VALUES (1);
INSERT INTO test VALUES (2);
INSERT INTO test VALUES (3);
INSERT INTO test VALUES (4);
COMMIT;
```

With `autosave=server`, the above query will insert values `(1), (3) and
(4)` and disregard the `duplicate key violation` error.

The `artifacts` directory contains the pgjdbc jar file
`postgresql-REL2Q.42.2.3.180601.jar`. This file needs to
be added to the CLASSPATH as usual. It also contains the
`postgresql-REL2Q.42.2.3.180601-tests.jar` jar that can be used to test
the latest `autosave` functionality.

The BatchAutoSaveTest.java file provided in the `artifacts` can be
tested by following the below mentioned steps:

-   Export CLASSPATH so that we can build and run the test case

```sh-session
    cd artifacts
    export CLASSPATH=$PWD:$PWD/postgresql-REL2Q.42.2.3.180601-tests.jar:$PWD/postgresql-REL2Q.42.2.3.180601.jar:$PWD/junit-4.12.jar:$PWD/hamcrest-core-1.3.jar
```

-   Compile the supplied test file

```sh-session
    javac -d . BatchAutoSaveTest.java
```

-   Run the test (assuming user as `test` and running on localhost)

```sh-session
    java -Dusername=test -Dport=5432 -Dhost=localhost -Ddatabase=postgres org.junit.runner.JUnitCore org.postgresql.test.jdbc2.BatchAutoSaveTest
```

This should output something like this:

```sh-session
JUnit version 4.12
.Configuration file /Users/altaf/pg/artifacts/../build.properties does not exist. Consider adding it to specify test db host and login
Configuration file /Users/altaf/pg/artifacts/../build.local.properties does not exist. Consider adding it to specify test db host and login
Configuration file /Users/altaf/pg/artifacts/../build.properties does not exist. Consider adding it to specify test db host and login
Configuration file /Users/altaf/pg/artifacts/../build.local.properties does not exist. Consider adding it to specify test db host and login
.........
Time: 0.556

OK (10 tests)
```

To modify the test cases, one can modify the BatchAutoSaveTest.java file
in the `artifacts` directory and run the last two commands specified
above to compile and run the test cases.
